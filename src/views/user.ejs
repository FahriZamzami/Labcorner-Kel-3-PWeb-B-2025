<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%- title %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .form-input { @apply w-full bg-slate-100 text-slate-800 placeholder-slate-400 px-4 py-2 rounded-lg border border-slate-300 focus:ring-2 focus:ring-purple-500 focus:outline-none focus:border-purple-500; }
    .bg-gradient-animated {
      background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
    }
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-purple-50 min-h-screen text-slate-800 font-[Inter]">
  <!-- Background Elements -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute -top-40 -right-40 w-80 h-80 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
    <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>
    <div class="absolute top-40 left-40 w-80 h-80 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-4000"></div>
  </div>

  <div class="relative max-w-7xl mx-auto px-6 py-8 space-y-8 z-10">
    <!-- Header Section -->
    <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white/30">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
        <div class="flex items-center gap-6">
          <a href="/" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-bold px-6 py-3 rounded-2xl shadow-lg transition-all transform hover:scale-105 active:scale-95 text-lg flex items-center gap-2">
            <span class="text-xl">â†</span>
            <span>Kembali ke Dashboard</span>
          </a>
          <div>
            <h2 class="text-6xl font-black text-slate-900 drop-shadow-sm bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">ğŸ“‹ Daftar User</h2>
            <p class="text-slate-600 text-lg mt-2">Kelola semua user dalam sistem LabCorner</p>
          </div>
        </div>
        <div class="flex flex-col sm:flex-row items-center gap-4 w-full lg:w-auto">
          <div class="relative w-full sm:w-80">
            <input id="searchInput" type="text" placeholder="ğŸ” Cari user berdasarkan nama, username, atau peran..." class="w-full bg-white/90 backdrop-blur-sm text-slate-700 placeholder-slate-400 px-6 py-4 rounded-2xl border-2 border-slate-200 focus:ring-4 focus:ring-purple-500/30 focus:outline-none focus:border-purple-500 transition-all duration-300 shadow-lg text-lg">
          </div>
          <div class="flex gap-3">
            <a href="/user/tambah" class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold px-6 py-4 rounded-2xl shadow-lg transition-all transform hover:scale-105 active:scale-95 text-lg flex items-center gap-2">
              <span class="text-xl">â•</span>
              <span>Tambah User</span>
            </a>
            <a href="/user/hapus" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-600 hover:to-pink-700 text-white font-bold px-6 py-4 rounded-2xl shadow-lg transition-all transform hover:scale-105 active:scale-95 text-lg flex items-center gap-2">
              <span class="text-xl">ğŸ—‘ï¸</span>
              <span>Hapus User</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- User Grid Section -->
    <div class="bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white/30">
      <div id="userGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
      <div id="noResult" class="text-center py-16 hidden">
        <div class="text-8xl mb-4">ğŸ”</div>
        <h3 class="text-3xl font-bold text-slate-700 mb-2">Data User Tidak Ditemukan</h3>
        <p class="text-slate-500 text-lg">Coba ubah kata kunci pencarian Anda</p>
      </div>
    </div>
  </div>

  <div id="toast" class="fixed top-6 right-6 px-8 py-4 rounded-2xl shadow-2xl transform translate-x-[120%] transition-transform duration-500 z-50 text-lg font-semibold"></div>

  <template id="userCardTemplate">
    <div class="user-card transition-all duration-500">
      <div class="card-content relative h-full bg-white/90 backdrop-blur-sm border-2 border-slate-200 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 group">
        <div class="card-display p-8 flex flex-col h-full opacity-100 transition-opacity duration-300">
          <div class="flex items-center gap-6 mb-6">
            <div class="avatar w-20 h-20 bg-gradient-to-br from-purple-400 to-blue-500 text-white rounded-2xl flex items-center justify-center text-4xl font-black flex-shrink-0 shadow-lg group-hover:scale-110 transition-transform duration-300"></div>
            <div class="flex-1 min-w-0">
              <h3 class="card-nama text-3xl font-black text-slate-900 truncate mb-2"></h3>
              <p class="card-username text-xl text-purple-600 font-semibold truncate"></p>
            </div>
          </div>
          <div class="mb-6">
            <div class="flex items-center gap-3 p-4 bg-slate-50 rounded-2xl">
              <span class="text-2xl">ğŸ‘¤</span>
              <div>
                <p class="text-slate-500 text-sm font-medium">Peran</p>
                <p class="card-peran text-lg font-bold text-slate-800"></p>
              </div>
            </div>
          </div>
          <div class="pt-6 mt-auto border-t-2 border-slate-100 text-right">
            <button class="edit-btn bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white font-bold px-8 py-4 rounded-2xl shadow-lg transition-all transform hover:scale-105 active:scale-95 text-lg">âœï¸ Edit User</button>
          </div>
        </div>
        <form class="card-edit p-8 space-y-6 absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-300 bg-white/95 backdrop-blur-sm rounded-3xl">
          <h4 class="text-2xl font-bold text-slate-900 mb-6">âœï¸ Edit User</h4>
          <div class="form-field">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Nama Lengkap</label>
            <input type="text" class="edit-nama form-input text-lg py-3" placeholder="Masukkan nama lengkap">
          </div>
          <div class="form-field">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Username</label>
            <input type="text" class="edit-username form-input text-lg py-3" placeholder="Masukkan username">
          </div>
          <div class="form-field">
            <label class="block text-sm font-semibold text-slate-700 mb-2">Peran</label>
            <select class="edit-peran form-input text-lg py-3">
              <option value="mahasiswa">Mahasiswa</option>
              <option value="asisten">Asisten</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="flex justify-end gap-4 pt-4">
            <button type="button" class="cancel-btn bg-gray-500 hover:bg-gray-600 text-white font-bold px-6 py-3 rounded-2xl transform active:scale-95 transition-all">âŒ Batal</button>
            <button type="submit" class="save-btn bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold px-8 py-3 rounded-2xl transform active:scale-95 transition-all">ğŸ’¾ Simpan</button>
          </div>
        </form>
      </div>
    </div>
  </template>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let users = <%- JSON.stringify(users || []) %>;

      const userGrid = document.getElementById('userGrid');
      const noResult = document.getElementById('noResult');
      const searchInput = document.getElementById('searchInput');

      // Render users to the grid
      function renderUsers(userList) {
        userGrid.innerHTML = '';
        if (userList.length === 0) {
          noResult.classList.remove('hidden');
          return;
        } else {
          noResult.classList.add('hidden');
        }
        userList.forEach(user => {
          const template = document.getElementById('userCardTemplate');
          const clone = template.content.cloneNode(true);
          clone.querySelector('.card-nama').textContent = user.fullName || '';
          clone.querySelector('.card-username').textContent = `@${user.username}`;
          clone.querySelector('.card-peran').textContent = user.peran;
          clone.querySelector('.avatar').textContent = user.fullName ? user.fullName.charAt(0) : '';
          const card = clone.querySelector('.user-card');

          // Edit button
          const editBtn = clone.querySelector('.edit-btn');
          const cardEditForm = clone.querySelector('.card-edit');
          const cardDisplay = clone.querySelector('.card-display');
          const cancelBtn = clone.querySelector('.cancel-btn');
          const saveBtn = clone.querySelector('.save-btn');

          editBtn.addEventListener('click', () => {
            cardEditForm.style.opacity = '1';
            cardEditForm.style.pointerEvents = 'auto';
            cardDisplay.style.opacity = '0';
            cardDisplay.style.pointerEvents = 'none';

            // Fill form with current data
            cardEditForm.querySelector('.edit-nama').value = user.fullName || '';
            cardEditForm.querySelector('.edit-username').value = user.username;
            cardEditForm.querySelector('.edit-peran').value = user.peran;
          });

          cancelBtn.addEventListener('click', () => {
            cardEditForm.style.opacity = '0';
            cardEditForm.style.pointerEvents = 'none';
            cardDisplay.style.opacity = '1';
            cardDisplay.style.pointerEvents = 'auto';
          });

          saveBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const updatedData = {
              nama: cardEditForm.querySelector('.edit-nama').value,
              username: cardEditForm.querySelector('.edit-username').value,
              peran: cardEditForm.querySelector('.edit-peran').value,
            };
            try {
              const response = await fetch(`/user/update/${user.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
              });
              const result = await response.json();
              if (!response.ok) throw new Error(result.message);

              // Update local users array
              users = users.map(u => u.id === user.id ? { ...u, fullName: updatedData.nama, username: updatedData.username, peran: updatedData.peran } : u);
              renderUsers(users);
              showToast('âœ… User berhasil diperbarui', 'success');
            } catch (error) {
              showToast('âŒ ' + error.message, 'error');
            }
          });

          userGrid.appendChild(clone);
        });
      }

      // Search functionality
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        const filteredUsers = users.filter(user =>
          (user.fullName && user.fullName.toLowerCase().includes(query)) ||
          user.username.toLowerCase().includes(query) ||
          user.peran.toLowerCase().includes(query)
        );
        renderUsers(filteredUsers);
      });

      // Toast notification
      function showToast(message, type) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `fixed top-6 right-6 px-8 py-4 rounded-2xl shadow-2xl transform translate-x-0 transition-transform duration-500 z-50 text-lg font-semibold ${
          type === 'success' ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white' : 'bg-gradient-to-r from-red-500 to-pink-600 text-white'
        }`;
        setTimeout(() => {
          toast.className = 'fixed top-6 right-6 px-8 py-4 rounded-2xl shadow-2xl transform translate-x-[120%] transition-transform duration-500 z-50 text-lg font-semibold';
        }, 4000);
      }

      // Initial render
      renderUsers(users);
    });
  </script>
</body>
</html>
